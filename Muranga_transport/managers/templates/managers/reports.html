{% extends "managers/base.html" %}
{% load static %}

{% block title %}Maintenance Reports | Murang'a Transport{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'managers/css/reports.css' %}">
{% endblock %}

{% block content %}
  <!-- Main Content -->
  <div class="main-content">
    <!-- Top Navigation Bar -->
    <header class="top-nav">
      <button class="sidebar-toggle">
        <i class="fas fa-bars"></i>
      </button>
      <div class="nav-right">
        <span class="user-greeting">
          {% if user %}
            Welcome, {{ user.first_name|default:"Transport Manager" }}
          {% else %}
            Welcome, Transport Manager
          {% endif %}
        </span>
        <img src="{% static 'managers/images/murangalogo.png' %}" alt="User" class="user-avatar">
      </div>
    </header>

    <div class="page-header">
      <h1 class="page-title">Maintenance Reports</h1>
      <p class="page-subtitle">View and manage reports for mechanics, drivers, and vehicles</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-label"><i class="fas fa-flag"></i> Total Requests</span>
        <span class="stat-value">{{ total_requests }}</span>
      </div>
      <div class="stat-card">
        <span class="stat-label"><i class="fas fa-clock"></i> Pending</span>
        <span class="stat-value">{{ pending_requests }}</span>
      </div>
      <div class="stat-card">
        <span class="stat-label"><i class="fas fa-check-circle"></i> Completed</span>
        <span class="stat-value">{{ completed_requests }}</span>
      </div>
      <div class="stat-card">
        <span class="stat-label"><i class="fas fa-exclamation-triangle"></i> High Priority</span>
        <span class="stat-value">{{ high_priority_requests }}</span>
      </div>
    </div>

    <!-- Chart -->
    <div class="reports-dashboard">
      <div class="dashboard-card">
        <div class="card-header">
          <h2 class="card-title"><i class="fas fa-chart-bar"></i> Requests per Vehicle</h2>
        </div>
        <canvas id="vehicleChart" style="max-height: 400px;"></canvas>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-row">
      <form method="get" class="filters-form">
        <div class="filter-group">
          <label class="filter-label">Status</label>
          <select class="filter-select" name="status">
            <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Statuses</option>
            {% for choice in requests.model.STATUS_CHOICES %}
              <option value="{{ choice.0 }}" {% if status_filter == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Vehicle</label>
          <select class="filter-select" name="vehicle">
            <option value="all" {% if vehicle_filter == 'all' %}selected{% endif %}>All Vehicles</option>
            {% for vehicle in vehicles %}
              <option value="{{ vehicle.number_plate }}" {% if vehicle_filter == vehicle.number_plate %}selected{% endif %}>{{ vehicle.number_plate }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Driver</label>
          <select class="filter-select" name="driver">
            <option value="all" {% if driver_filter == 'all' %}selected{% endif %}>All Drivers</option>
            {% for driver in drivers %}
              <option value="{{ driver.driver_id }}" {% if driver_filter == driver.driver_id %}selected{% endif %}>
                {{ driver.user__first_name }} {{ driver.user__last_name|default_if_none:"" }} {% if not driver.user__first_name and not driver.user__last_name %}({{ driver.user__username }}){% endif %}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Mechanic</label>
          <select class="filter-select" name="mechanic">
            <option value="all" {% if mechanic_filter == 'all' %}selected{% endif %}>All Mechanics</option>
            {% for mechanic in mechanics %}
              <option value="{{ mechanic.mechanic_id }}" {% if mechanic_filter == mechanic.mechanic_id %}selected{% endif %}>{{ mechanic.full_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Date Range</label>
          <select class="filter-select" name="date_range">
            <option value="all" {% if date_range == 'all' %}selected{% endif %}>All Time</option>
            <option value="today" {% if date_range == 'today' %}selected{% endif %}>Today</option>
            <option value="week" {% if date_range == 'week' %}selected{% endif %}>This Week</option>
            <option value="month" {% if date_range == 'month' %}selected{% endif %}>This Month</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Apply Filters</button>
      </form>
    </div>

    <!-- Reports Tabs -->
    <div class="reports-dashboard">
      <div class="dashboard-card">
        <div class="card-header">
          <h2 class="card-title"><i class="fas fa-list"></i> Reports</h2>
          <div class="card-actions">
            <a href="{% url 'managers:export_reports' %}" class="btn btn-outline"><i class="fas fa-download"></i> Export CSV</a>
          </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="mechanic">Mechanic Reports</button>
          <button class="tab-btn" data-tab="driver">Driver Reports</button>
          <button class="tab-btn" data-tab="vehicle">Vehicle Reports</button>
        </div>

        <!-- Mechanic Reports -->
        <div class="tab-content active" id="mechanic">
          <table class="reports-table">
            <thead>
              <tr>
                <th>Mechanic</th>
                <th>Tasks Completed</th>
                <th>Total Cost</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              {% for mechanic in mechanic_stats %}
                {% if mechanic.mechanic_id %}
                  <tr>
                    <td>{{ mechanic.full_name|default:"Unknown" }}</td>
                    <td>{{ mechanic.total_tasks }}</td>
                    <td>{{ mechanic.total_cost|floatformat:2|default:"0.00" }}</td>
                    <td>
                      <a href="{% url 'managers:report_details' report_type='mechanic' report_id=mechanic.mechanic_id %}" class="btn btn-outline btn-sm">View Details</a>
                    </td>
                  </tr>
                {% endif %}
              {% empty %}
                <tr><td colspan="4">No mechanic data available.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Driver Reports -->
        <div class="tab-content" id="driver">
          <table class="reports-table">
            <thead>
              <tr>
                <th>Driver</th>
                <th>Total Requests</th>
                <th>Total Issues</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              {% for driver in driver_stats %}
                {% if driver.driver_id %}
                  <tr>
                    <td>{{ driver.user__first_name }} {{ driver.user__last_name|default_if_none:"" }} {% if not driver.user__first_name and not driver.user__last_name %}({{ driver.user__username }}){% endif %}</td>
                    <td>{{ driver.total_requests }}</td>
                    <td>{{ driver.total_issues }}</td>
                    <td>
                      <a href="{% url 'managers:report_details' report_type='driver' report_id=driver.driver_id %}" class="btn btn-outline btn-sm">View Details</a>
                    </td>
                  </tr>
                {% endif %}
              {% empty %}
                <tr><td colspan="4">No driver data available.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Vehicle Reports -->
        <div class="tab-content" id="vehicle">
          <table class="reports-table">
            <thead>
              <tr>
                <th>Vehicle</th>
                <th>Total Requests</th>
                <th>Total Cost</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              {% for vehicle in vehicle_stats %}
                {% if vehicle.number_plate %}
                  <tr>
                    <td>{{ vehicle.make }} {{ vehicle.model }} ({{ vehicle.number_plate }})</td>
                    <td>{{ vehicle.total_requests }}</td>
                    <td>{{ vehicle.total_cost|floatformat:2|default:"0.00" }}</td>
                    <td>
                      <a href="{% url 'managers:report_details' report_type='vehicle' report_id=vehicle.number_plate %}" class="btn btn-outline btn-sm">View Details</a>
                    </td>
                  </tr>
                {% endif %}
              {% empty %}
                <tr><td colspan="4">No vehicle data available.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js Script -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Chart.js
      const ctx = document.getElementById('vehicleChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: {{ chart_labels|safe }},
          datasets: [{
            label: 'Maintenance Requests',
            data: {{ chart_data|safe }},
            backgroundColor: 'rgba(46, 125, 50, 0.5)', // Matches --primary-color
            borderColor: 'rgba(46, 125, 50, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      // Tab Switching
      document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          button.classList.add('active');
          document.getElementById(button.dataset.tab).classList.add('active');
        });
      });
    });
  </script>
{% endblock %}